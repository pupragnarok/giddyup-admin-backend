#!/bin/bash

set -e

echo â€œğŸ¤  Giddyup Admin Console - Installation Scriptâ€
echo â€œ==================================================â€
echo â€œâ€

# Color codes

GREEN=â€™\033[0;32mâ€™
YELLOW=â€™\033[1;33mâ€™
RED=â€™\033[0;31mâ€™
NC=â€™\033[0mâ€™ # No Color

# Check if running as root

if [ â€œ$EUIDâ€ -ne 0 ]; then
echo -e â€œ${RED}Please run as root or with sudo${NC}â€
exit 1
fi

# Check for required commands

command -v docker >/dev/null 2>&1 || { echo -e â€œ${RED}Docker is required but not installed. Aborting.${NC}â€ >&2; exit 1; }
command -v docker-compose >/dev/null 2>&1 || command -v docker compose >/dev/null 2>&1 || { echo -e â€œ${RED}Docker Compose is required but not installed. Aborting.${NC}â€ >&2; exit 1; }

# Prompt for domain

echo -e â€œ${YELLOW}Enter your domain for the admin console (e.g., admin.giddyup.cloud):${NC}â€
read -p â€œDomain: â€œ DOMAIN

if [ -z â€œ$DOMAINâ€ ]; then
echo -e â€œ${RED}Domain cannot be empty. Aborting.${NC}â€
exit 1
fi

echo â€œâ€
echo -e â€œ${GREEN}Installing to: /opt/giddyup-admin${NC}â€
echo -e â€œ${GREEN}Domain: $DOMAIN${NC}â€
echo â€œâ€

# Stop and remove existing container if running

echo â€œâ¹ï¸  Stopping any existing containersâ€¦â€
cd /opt/giddyup-admin 2>/dev/null && docker-compose down 2>/dev/null || true
docker rm -f giddyup-admin-console 2>/dev/null || true

# Clean up and recreate directory structure

echo â€œğŸ§¹ Cleaning up old filesâ€¦â€
rm -rf /opt/giddyup-admin
mkdir -p /opt/giddyup-admin/app/src

echo â€œğŸ“ Creating configuration filesâ€¦â€

# Create docker-compose.yml

cat > /opt/giddyup-admin/docker-compose.yml << EOF
version: â€˜3.8â€™

services:
giddyup-admin:
image: node:18-alpine
container_name: giddyup-admin-console
working_dir: /app
volumes:
- ./app:/app
- /var/run/docker.sock:/var/run/docker.sock:ro
environment:
- NODE_ENV=production
command: sh -c â€œnpm install && npm run build && npx serve -s dist -l 3000â€
networks:
- traefik_network
labels:
- â€œtraefik.enable=trueâ€
- â€œtraefik.http.routers.giddyup-admin.rule=Host(\`${DOMAIN}\`)â€
- â€œtraefik.http.routers.giddyup-admin.entrypoints=webâ€
- â€œtraefik.http.routers.giddyup-admin.middlewares=redirect-to-httpsâ€
- â€œtraefik.http.routers.giddyup-admin-secure.rule=Host(\`${DOMAIN}\`)â€
- â€œtraefik.http.routers.giddyup-admin-secure.entrypoints=websecureâ€
- â€œtraefik.http.routers.giddyup-admin-secure.tls=trueâ€
- â€œtraefik.http.routers.giddyup-admin-secure.tls.certresolver=letsencryptâ€
- â€œtraefik.http.services.giddyup-admin.loadbalancer.server.port=3000â€
- â€œtraefik.http.middlewares.redirect-to-https.redirectscheme.scheme=httpsâ€
- â€œtraefik.http.middlewares.redirect-to-https.redirectscheme.permanent=trueâ€
restart: unless-stopped

networks:
traefik_network:
external: true
EOF

# Create package.json

cat > /opt/giddyup-admin/app/package.json << â€˜EOFâ€™
{
â€œnameâ€: â€œgiddyup-admin-consoleâ€,
â€œversionâ€: â€œ1.0.0â€,
â€œtypeâ€: â€œmoduleâ€,
â€œscriptsâ€: {
â€œdevâ€: â€œviteâ€,
â€œbuildâ€: â€œvite buildâ€,
â€œpreviewâ€: â€œvite previewâ€
},
â€œdependenciesâ€: {
â€œreactâ€: â€œ^18.2.0â€,
â€œreact-domâ€: â€œ^18.2.0â€,
â€œlucide-reactâ€: â€œ^0.263.1â€
},
â€œdevDependenciesâ€: {
â€œ@vitejs/plugin-reactâ€: â€œ^4.0.0â€,
â€œviteâ€: â€œ^4.3.9â€,
â€œserveâ€: â€œ^14.2.0â€
}
}
EOF

# Create vite.config.js

cat > /opt/giddyup-admin/app/vite.config.js << â€˜EOFâ€™
import { defineConfig } from â€˜viteâ€™
import react from â€˜@vitejs/plugin-reactâ€™

export default defineConfig({
plugins: [react()],
server: {
host: â€˜0.0.0.0â€™,
port: 3000
}
})
EOF

# Create index.html

cat > /opt/giddyup-admin/app/index.html << â€˜EOFâ€™

<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Giddyup Admin Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
EOF

# Create main.jsx

cat > /opt/giddyup-admin/app/src/main.jsx << â€˜EOFâ€™
import React from â€˜reactâ€™
import ReactDOM from â€˜react-dom/clientâ€™
import App from â€˜./App.jsxâ€™

ReactDOM.createRoot(document.getElementById(â€˜rootâ€™)).render(
<React.StrictMode>
<App />
</React.StrictMode>,
)
EOF

# Download App.jsx from GitHub

echo â€œğŸ“¥ Downloading App.jsxâ€¦â€
curl -sSL https://raw.githubusercontent.com/pupragnarok/giddyup-admin-backend/main/admin/app/src/App.jsx -o /opt/giddyup-admin/app/src/App.jsx

if [ ! -f /opt/giddyup-admin/app/src/App.jsx ]; then
echo -e â€œ${RED}Failed to download App.jsx. Aborting.${NC}â€
exit 1
fi

echo â€œâ€
echo -e â€œ${GREEN}âœ… All files created successfully!${NC}â€
echo â€œâ€

# Display file structure

echo â€œğŸ“ Directory structure:â€
find /opt/giddyup-admin -type f | sort

echo â€œâ€
echo â€œğŸš€ Starting deploymentâ€¦â€
cd /opt/giddyup-admin
docker-compose up -d

echo â€œâ€
echo -e â€œ${GREEN}âœ… Deployment started!${NC}â€
echo â€œâ€
echo â€œğŸ“Š Monitoring initial build (this may take 2-3 minutes)â€¦â€
echo â€œ   Press Ctrl+C to exit logs (container will keep running)â€
echo â€œâ€

sleep 3
docker logs -f giddyup-admin-console 2>&1 &
LOGS_PID=$!

# Wait for the build to complete or timeout after 5 minutes

TIMEOUT=300
ELAPSED=0
while [ $ELAPSED -lt $TIMEOUT ]; do
if docker logs giddyup-admin-console 2>&1 | grep -q â€œAccepting connectionsâ€; then
echo â€œâ€
echo -e â€œ${GREEN}âœ… Build complete! Server is running.${NC}â€
kill $LOGS_PID 2>/dev/null || true
break
fi
sleep 5
ELAPSED=$((ELAPSED + 5))
done

echo â€œâ€
echo â€œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â€
echo -e â€œ${GREEN}ğŸ‰ Installation Complete!${NC}â€
echo â€œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â€
echo â€œâ€
echo â€œğŸŒ Access your admin console at:â€
echo -e â€œ   ${GREEN}https://${DOMAIN}${NC}â€
echo â€œâ€
echo â€œğŸ“ Useful commands:â€
echo â€œ   View logs:    docker logs -f giddyup-admin-consoleâ€
echo â€œ   Restart:      cd /opt/giddyup-admin && docker-compose restartâ€
echo â€œ   Stop:         cd /opt/giddyup-admin && docker-compose downâ€
echo â€œ   Rebuild:      cd /opt/giddyup-admin && docker-compose up -d â€“buildâ€
echo â€œâ€
echo â€œâš ï¸  Remember to:â€
echo â€œ   1. Add DNS A record: $DOMAIN â†’ your-server-ipâ€
echo â€œ   2. Wait for DNS propagation (5-10 minutes)â€
echo â€œ   3. Letâ€™s Encrypt will automatically generate SSL certificateâ€
echo â€œâ€
echo â€œğŸ¤  Happy wrangling!â€
echo â€œâ€